<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Efficient intra-process communication</title>
    <meta name="description" content="a community-maintained index of robotics software
">

    
    <link rel="canonical" href="https://ros-infrastructure.github.io/index.ros.org//doc/ros2/Tutorials/Intra-Process-Communication/">
    
    <link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/sphinx.css">
    

    <script type="text/javascript" src=/js/jquery.js></script>
    <script src=/bootstrap/js/bootstrap.min.js type="text/javascript"></script>
    <script src=/js/jquery-cookie-1.4.1/jquery.cookie.js type="text/javascript"></script>

    <script type="text/javascript" src=/js/ga.js async></script>
    <script type="text/javascript" src=/js/toc.js></script>

    <script src=/js/distro_switch.js></script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">
    <div class="container-fluid" style="margin-bottom: 10px">

      <div align="center">
        <br>
        <table id="topnav-table">
          <tr>
            <td valign="middle">
                ROS Resources:
              <a href="http://wiki.ros.org/">Documentation</a>
              |
              <a href="http://wiki.ros.org/Support">Support</a>
              |
              <a href="http://discourse.ros.org/">Discussion Forum</a>
              |
              <a href="http://status.ros.org/">Service Status</a>
              |
              <a href="http://answers.ros.org/">Q&A answers.ros.org</a>
            </td>
          </tr>
        </table> <!-- topnav-table -->
      </div>

      <div class="row">

        <div class="col-sm-12 col-md-9" style="margin-top: 8px">
          <div class="row">
            <!-- title -->
            <div class="col-xs-12 col-sm-3 col-md-3" style="white-space:nowrap;">
              <a class="site-title" href="/">ROS Index</a> <sup><a href="https://github.com/ros-infrastructure/rosindex/issues/new" style="vertical-align:super;" class="label label-warning" target="_blank">BETA</a></sup>
            </div>

            <!-- main links -->
            <div class="col-xs-12 col-sm-9 col-md-9 text-right">
              <ul class="list-inline" style="margin-bottom:0px;">
                <li><a class="btn btn-link" href="/about">About</a></li>

                <li class="dropdown">
                  <button id="dLabel" class="btn btn-link" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Index <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                    <li><a href="/packages/page/1/time/">Package List</a></li>
                    <li><a href="/repos/page/1/time/">Repository List</a></li>

                    <li class="hidden" class="divider"></li>


                    <li class="hidden"><a href="/srvs/">Nodes</a></li>
                    <li class="hidden"><a href="/msgs/">Messages</a></li>
                    <li class="hidden"><a href="/srvs/">Services</a></li>
                    <li class="hidden"><a href="/srvs/">Plugins</a></li>

                    <li class="divider"></li>

                    <li><a href="/deps/">System Dependencies</a></li>
                  </ul>
                </li>

                <li class="dropdown disabled">
                  <button id="dLabel" class="btn btn-link" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Doc <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                    
                    <li>
                      <a href="/doc/ros2">
                        ROS2 Overview
                      </a>
                    </li>
                    
                    <li class="hidden" class="divider"></li>

                    <li class="hidden"><a href="/doc/tutorials">Tutorials</a></li>
                    <li class="hidden"><a href="/doc/readmes">Readmes</a></li>
                    <li class="hidden"><a href="/doc/apis">APIs</a></li>
                  </ul>
                </li>

                <li><a class="btn btn-link" href="/contribute">Contribute</a></li>
                <li><a class="btn btn-link" href="/stats">Stats</a></li>
              </ul>

            </div>
          </div>
        </div>

        <!-- searchbox -->
        <div class="col-sm-12 col-md-3" style="margin-top: 12px">
          <form id="top-searchbox" action="/search/" role="form" method="get">
            <div class="input-group input-group-sm">
              <input type="text" class="form-control" name="term" placeholder="Search ROS">
              <span class="input-group-btn">
                <button class="btn btn-default btn-sm" title="Search ROS" type="submit">
                  <span class="glyphicon glyphicon-search"></span>
                </button>
                <a href="https://lunrjs.com/guides/searching.html"
                   title="Help to Search" class="btn btn-default btn-sm">
                  <span class="glyphicon glyphicon-question-sign"></span>
                </a>
              </span>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!--
    <a class="site-title" href="/">ROS Index</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/packages">Packages</a>
        <a class="page-link" href="/repos">Repositories</a>
        <a class="page-link" href="/search">Search</a>
      </div>
    </nav>
    -->

  </div>
  <script type="text/javascript">
    $('#top-searchbox').submit(function() {
        return $('#top-searchbox input:text').filter(function() {
          return $(this).val() == "";
        }).length == 0;
    });
  </script>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="container-fluid" style="margin-top: 20px">
  <div class="row">
    <ol class="breadcrumb">
      <li><a href="/">Home</a></li>
      
      <li>
        <a href="/doc/ros2/">
          ROS2 Overview
        </a>
      </li>
      
      <li>
        <a href="/doc/ros2/Tutorials/">
          Tutorials
        </a>
      </li>
      
      <li class="active">Efficient intra-process communication</li>
    </ol>
  </div>
  <div class="row">
    <nav class="col-md-4 well">
      <h3 style="margin-top: 10px;">Index</h3>
      
      
      <div class="list-group list-group-root">
  



<div class="list-group-item">
  <a href="/doc/ros2/">ROS2 Overview</a>
  
  <a href="#_doc_ros2__children" class="list-group-toggle pull-right"
     data-toggle="collapse" aria-expanded="false">
    
    <span class="glyphicon glyphicon-chevron-up"></span>
    
  </a>
  
</div>

  
<div id="_doc_ros2__children" class="list-group collapse in">
  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/About/">About this documentation</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Concepts/">ROS 2 Concepts</a>
  
  <a href="#_doc_ros2_Concepts__children" class="list-group-toggle pull-right"
     data-toggle="collapse" aria-expanded="false">
    
    <span class="glyphicon glyphicon-chevron-down"></span>
    
  </a>
  
</div>

  
<div id="_doc_ros2_Concepts__children" class="list-group collapse">
  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Concepts/About-Quality-of-Service-Settings/">About Quality of Service Settings</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Concepts/About-ROS-Interfaces/">About ROS 2 Interfaces</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Concepts/ROS-2-Client-Libraries/">About ROS2 client libraries</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Concepts/Logging/">Logging and logger configuration</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Concepts/Overview-of-ROS-2-concepts/">Overview of ROS 2 Concepts</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Concepts/DDS-and-ROS-middleware-implementations/">ROS 2 and different DDS/RTPS vendors</a>
  
</div>



  
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Contributing/">Contributing to ROS 2</a>
  
  <a href="#_doc_ros2_Contributing__children" class="list-group-toggle pull-right"
     data-toggle="collapse" aria-expanded="false">
    
    <span class="glyphicon glyphicon-chevron-down"></span>
    
  </a>
  
</div>

  
<div id="_doc_ros2_Contributing__children" class="list-group collapse">
  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Contributing/Build-Cop-and-Build-Farmer-Guide/">Build Cop and Build Farmer Guide</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Contributing/Design-Guide/">Design Guide: Common patterns in ROS 2</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Contributing/Examples-and-Tools-for-ROS1----ROS2-Migrations/">Examples and tools for ROS1-to-ROS2 Migration</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Contributing/Set-up-a-new-Linux-CI-node/">How to setup Linux Jenkins nodes</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Contributing/Set-up-a-new-Windows-CI-node/">How to setup a Windows Jenkins node</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Contributing/Set-up-a-new-macOS-CI-node/">How to setup a macOS Jenkins node</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Contributing/CI-Server-Setup/">How to setup the Jenkins master</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Contributing/MISRA-Compliance-Guide/">MISRA Compliance Guide</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Contributing/Migration-Guide/">Migration guide from ROS 1</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Contributing/Migration-Guide-Python/">Python Migration guide from ROS 1</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Contributing/Quality-Guide/">Quality Guide: Ensuring code quality</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Contributing/Developer-Guide/">ROS 2 Developer Guide</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Contributing/ROS-2-On-boarding-Guide/">ROS 2 On-boarding Guide</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Contributing/Inter-Sphinx-Support/">Using Sphinx for cross-referencing packages</a>
  
</div>



  
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Contact/">Contact us</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Features/">Features Status</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/">Installation</a>
  
  <a href="#_doc_ros2_Installation__children" class="list-group-toggle pull-right"
     data-toggle="collapse" aria-expanded="false">
    
    <span class="glyphicon glyphicon-chevron-down"></span>
    
  </a>
  
</div>

  
<div id="_doc_ros2_Installation__children" class="list-group collapse">
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Crystal/">Installing ROS 2 Crystal and earlier</a>
  
  <a href="#_doc_ros2_Installation_Crystal__children" class="list-group-toggle pull-right"
     data-toggle="collapse" aria-expanded="false">
    
    <span class="glyphicon glyphicon-chevron-down"></span>
    
  </a>
  
</div>

  
<div id="_doc_ros2_Installation_Crystal__children" class="list-group collapse">
  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Crystal/Fedora-Development-Setup/">Building ROS 2 on Fedora Linux</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Crystal/Linux-Development-Setup/">Building ROS 2 on Linux</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Crystal/OSX-Development-Setup/">Building ROS 2 on OS X</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Crystal/Windows-Development-Setup/">Building ROS 2 on Windows</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Crystal/Install-Connext-Security-Plugins/">Installing Connext security plugins</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Crystal/Linux-Install-Binary/">Installing ROS 2 on Linux</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Crystal/OSX-Install-Binary/">Installing ROS 2 on OS X</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Crystal/Windows-Install-Binary/">Installing ROS 2 on Windows</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Crystal/Linux-Install-Debians/">Installing ROS2 via Debian Packages</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Crystal/Maintaining-a-Source-Checkout/">Maintaining a Source Checkout of ROS 2</a>
  
</div>



  
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Dashing/">Installing ROS 2 Dashing Diademata</a>
  
  <a href="#_doc_ros2_Installation_Dashing__children" class="list-group-toggle pull-right"
     data-toggle="collapse" aria-expanded="false">
    
    <span class="glyphicon glyphicon-chevron-down"></span>
    
  </a>
  
</div>

  
<div id="_doc_ros2_Installation_Dashing__children" class="list-group collapse">
  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Dashing/Fedora-Development-Setup/">Building ROS 2 on Fedora Linux</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Dashing/Linux-Development-Setup/">Building ROS 2 on Linux</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Dashing/OSX-Development-Setup/">Building ROS 2 on OS X</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Dashing/Windows-Development-Setup/">Building ROS 2 on Windows</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Dashing/Install-Connext-Security-Plugins/">Installing Connext security plugins</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Dashing/Linux-Install-Binary/">Installing ROS 2 on Linux</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Dashing/OSX-Install-Binary/">Installing ROS 2 on OS X</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Dashing/Windows-Install-Binary/">Installing ROS 2 on Windows</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Dashing/Linux-Install-Debians/">Installing ROS2 via Debian Packages</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Installation/Dashing/Maintaining-a-Source-Checkout/">Maintaining a Source Checkout of ROS 2</a>
  
</div>



  
  
</div>



  
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Releases/">ROS 2 Distributions</a>
  
  <a href="#_doc_ros2_Releases__children" class="list-group-toggle pull-right"
     data-toggle="collapse" aria-expanded="false">
    
    <span class="glyphicon glyphicon-chevron-down"></span>
    
  </a>
  
</div>

  
<div id="_doc_ros2_Releases__children" class="list-group collapse">
  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Releases/Beta1-Overview/">Beta 1 (codename ‘Asphalt’; December 2016)</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Releases/Beta2-Overview/">Beta 2 (codename ‘r2b2’; July 2017)</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Releases/Beta3-Overview/">Beta 3 (codename ‘r2b3’; September 2017)</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Releases/Release-Howto/">How to Release</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Releases/Release-Ardent-Apalone/">ROS 2 Ardent Apalone (codename ‘ardent’; December 2017)</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Releases/Release-Bouncy-Bolson/">ROS 2 Bouncy Bolson (codename ‘bouncy’; June 2018)</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Releases/Release-Crystal-Clemmys/">ROS 2 Crystal Clemmys (codename ‘crystal’; December 2018)</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Releases/Release-Dashing-Diademata/">ROS 2 Dashing Diademata (codename ‘dashing’; May 31st, 2019)</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Releases/Alpha-Overview/">ROS 2 alpha releases (Aug 2015 - Oct 2016)</a>
  
</div>



  
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Related-Projects/">Related Projects</a>
  
  <a href="#_doc_ros2_Related-Projects__children" class="list-group-toggle pull-right"
     data-toggle="collapse" aria-expanded="false">
    
    <span class="glyphicon glyphicon-chevron-down"></span>
    
  </a>
  
</div>

  
<div id="_doc_ros2_Related-Projects__children" class="list-group collapse">
  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Related-Projects/Intel-ROS2-Projects/">Intel ROS2 Projects</a>
  
</div>



  
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Roadmap/">Roadmap</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/">Tutorials</a>
  
  <a href="#_doc_ros2_Tutorials__children" class="list-group-toggle pull-right"
     data-toggle="collapse" aria-expanded="false">
    
    <span class="glyphicon glyphicon-chevron-up"></span>
    
  </a>
  
</div>

  
<div id="_doc_ros2_Tutorials__children" class="list-group collapse in">
  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Actions/">Actions</a>
  
  <a href="#_doc_ros2_Tutorials_Actions__children" class="list-group-toggle pull-right"
     data-toggle="collapse" aria-expanded="false">
    
    <span class="glyphicon glyphicon-chevron-down"></span>
    
  </a>
  
</div>

  
<div id="_doc_ros2_Tutorials_Actions__children" class="list-group collapse">
  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Actions/Creating-an-Action/">Creating an Action</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Actions/Writing-an-Action-Client-CPP/">Writing an Action Client (C++)</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Actions/Writing-an-Action-Client-Python/">Writing an Action Client (Python)</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Actions/Writing-an-Action-Server-CPP/">Writing an Action Server (C++)</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Actions/Writing-an-Action-Server-Python/">Writing an Action Server (Python)</a>
  
</div>



  
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Building-ROS-2-on-Linux-with-Eclipse-Oxygen/">Building ROS2 on Linux with Eclipse Oxygen [community-contributed]</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/RQt-Source-Install/">Building RQt from Source</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/RQt-Source-Install-Windows10/">Building RQt from Source on Windows 10</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/RQt-Source-Install-MacOS/">Building RQt from Source on macOS</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Building-Realtime-rt_preempt-kernel-for-ROS-2/">Building Realtime Linux for ROS 2 [community-contributed]</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Composition/">Composing multiple nodes in a single process</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Cross-compilation/">Cross-Compilation</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Defining-custom-interfaces-(msg-srv)/">Defining custom interfaces (msg/srv)</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Eclipse-Oxygen-with-ROS-2-and-rviz2/">Eclipse Oxygen with ROS 2 and rviz2 [community-contributed]</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Intra-Process-Communication/">Efficient intra-process communication</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Allocator-Template-Tutorial/">Implement a custom memory allocator</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Rosidl-Tutorial/">Introduction to msg and srv interfaces</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Introspection-with-command-line-tools/">Introspection with command line tools</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Launch-system/">Launching/monitoring multiple nodes with Launch</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Logging-and-logger-configuration/">Logging and logger configuration demo</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Managed-Nodes/">Management of nodes with managed lifecycles</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/New-features-in-ROS-2-interfaces-(msg-srv)/">New features in ROS 2 interfaces</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/catment/">On the mixing of ament and catkin (catment)</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/RQt-Overview-Usage/">Overview and Usage of RQt</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Node-arguments/">Passing ROS arguments to nodes via the command-line</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/RQt-Port-Plugin-Windows/">Porting RQt plugins to Windows</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Python-Programming/">Python Programming in ROS 2</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Real-Time-Programming/">Real-Time Programming in ROS 2</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Rosbag-with-ROS1-Bridge/">Recording and playback of topic data with rosbag using the ROS 1 bridge</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Releasing-a-ROS-2-package-with-bloom/">Releasing a ROS 2 package with bloom</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Run-2-nodes-in-two-separate-docker-containers/">Running 2 nodes in 2 separate docker containers [community-contributed]</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Run-2-nodes-in-a-single-docker-container/">Running 2 nodes in a single docker container [community-contributed]</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/dummy-robot-demo/">Trying the dummy robot demo</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Quality-of-Service/">Use quality-of-service settings to handle lossy networks</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Ament-Tutorial/">Using Ament</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Colcon-Tutorial/">Using Colcon to build packages</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/tf2/">Using tf2 with ROS 2</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Working-with-multiple-RMW-implementations/">Working with multiple ROS 2 middleware implementations</a>
  
</div>



  
  
  
  



<div class="list-group-item">
  <a href="/doc/ros2/Tutorials/Ament-CMake-Documentation/">ament_cmake User Documentation</a>
  
</div>



  
  
</div>



  
  
</div>



</div>

<script type="text/javascript">
  $(function() {
    $('.list-group-toggle').on('click', function() {
      $(this).find('span').toggleClass(
        'glyphicon-chevron-up glyphicon-chevron-down'
      );
    });
  });
</script>

    </nav>
    <div class="col-md-8">
      <a type="button" href="https://github.com/ros2/ros2_documentation/edit/master/source/Tutorials/Intra-Process-Communication.rst"
         class="btn btn-success pull-right"
         style="margin-top: 20px;">
        Edit on Github
      </a>
      <div class="section" id="efficient-intra-process-communication">
<h1>Efficient intra-process communication<a class="headerlink" href="#efficient-intra-process-communication" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#background" id="id1">Background</a></p></li>
<li><p><a class="reference internal" href="#build-the-demos" id="id2">Build the demos</a></p></li>
<li><p><a class="reference internal" href="#running-and-understanding-the-demos" id="id3">Running and understanding the demos</a></p></li>
<li><p><a class="reference internal" href="#looking-forward" id="id4">Looking forward</a></p></li>
</ul>
</div>
<div class="section" id="background">
<h2><a class="toc-backref" href="#id1">Background</a><a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<p>ROS applications typically consist of a composition of individual “nodes” which perform narrow tasks and are decoupled from other parts of the system.
This promotes fault isolation, faster development, modularity, and code reuse, but it often comes at the cost of performance.
After ROS 1 was initially developed, the need for efficient composition of nodes became obvious and Nodelets were developed.
In ROS 2 we aim to improve on the design of Nodelets by addressing some fundamental problems that required restructuring of nodes.</p>
<p>In this demo we’ll be highlighting how nodes can be composed manually, by defining the nodes separately but combining them in different process layouts without changing the node’s code or limiting its abilities.</p>
</div>
<div class="section" id="build-the-demos">
<h2><a class="toc-backref" href="#id2">Build the demos</a><a class="headerlink" href="#build-the-demos" title="Permalink to this headline">¶</a></h2>
<p>These demos should work on any of the three major OSs (Windows, Mac, or Linux).
Some of them do require OpenCV to have been installed.</p>
<div class="section" id="using-the-pre-built-binaries">
<h3>Using the pre-built binaries<a class="headerlink" href="#using-the-pre-built-binaries" title="Permalink to this headline">¶</a></h3>
<p>If you’ve installed the binaries, simply source the ROS 2 setup file and then skip down to any of the individual demos to see how to run them.</p>
</div>
<div class="section" id="building-from-source">
<h3>Building from source<a class="headerlink" href="#building-from-source" title="Permalink to this headline">¶</a></h3>
<p>Make sure you have OpenCV installed and then follow the source instructions.
You can find the from source instructions linked from the main <a class="reference internal" href="../../Installation/"><span class="doc">ros2 installation page</span></a>.
Once built source the setup file and continue down to one of the specific demos to read about them and for instructions on how to run them.</p>
</div>
</div>
<div class="section" id="running-and-understanding-the-demos">
<h2><a class="toc-backref" href="#id3">Running and understanding the demos</a><a class="headerlink" href="#running-and-understanding-the-demos" title="Permalink to this headline">¶</a></h2>
<p>There are a few different demos: some are toy problems designed to highlight features of the intra process communications functionality and some are end to end examples which use OpenCV and demonstrate the ability to recombine nodes into different configurations.</p>
<div class="section" id="the-two-node-pipeline-demo">
<h3>The two node pipeline demo<a class="headerlink" href="#the-two-node-pipeline-demo" title="Permalink to this headline">¶</a></h3>
<p>This demo is designed to show that the intra process publish/subscribe connection can result in zero-copy transport of messages when publishing and subscribing with <code class="docutils literal notranslate"><span class="pre">std::unique_ptr</span></code>s.</p>
<p>First let’s take a look at the source:</p>
<p><a class="reference external" href="https://github.com/ros2/demos/blob/master/intra_process_demo/src/two_node_pipeline/two_node_pipeline.cpp">https://github.com/ros2/demos/blob/master/intra_process_demo/src/two_node_pipeline/two_node_pipeline.cpp</a></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;chrono&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cinttypes&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;rclcpp/rclcpp.hpp&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;std_msgs/msg/int32.hpp&quot;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono_literals</span><span class="p">;</span>

<span class="c1">// Node that produces messages.</span>
<span class="k">struct</span> <span class="nl">Producer</span> <span class="p">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="n">Producer</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">output</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Create a publisher on the output topic.</span>
    <span class="n">pub_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">rmw_qos_profile_default</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">remove_pointer</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="n">pub_</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;</span> <span class="n">captured_pub</span> <span class="o">=</span> <span class="n">pub_</span><span class="p">;</span>
    <span class="c1">// Create a timer which publishes on the output topic at ~1Hz.</span>
    <span class="k">auto</span> <span class="n">callback</span> <span class="o">=</span> <span class="p">[</span><span class="n">captured_pub</span><span class="p">]()</span> <span class="o">-&gt;</span> <span class="kt">void</span> <span class="p">{</span>
        <span class="k">auto</span> <span class="n">pub_ptr</span> <span class="o">=</span> <span class="n">captured_pub</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pub_ptr</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">static</span> <span class="kt">int32_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">::</span><span class="n">UniquePtr</span> <span class="n">msg</span><span class="p">(</span><span class="k">new</span> <span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="p">());</span>
        <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">count</span><span class="o">++</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span>
          <span class="s">&quot;Published message with value: %d, and address: 0x%&quot;</span> <span class="n">PRIXPTR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
          <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
        <span class="n">pub_ptr</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="n">timer_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_wall_timer</span><span class="p">(</span><span class="mi">1</span><span class="n">s</span><span class="p">,</span> <span class="n">callback</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">pub_</span><span class="p">;</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span> <span class="n">timer_</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// Node that consumes messages.</span>
<span class="k">struct</span> <span class="nl">Consumer</span> <span class="p">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="n">Consumer</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">input</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Create a subscription on the input topic which prints on receipt of new messages.</span>
    <span class="n">sub_</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;</span><span class="p">(</span>
      <span class="n">input</span><span class="p">,</span> <span class="p">[](</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">::</span><span class="n">UniquePtr</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span>
        <span class="s">&quot; Received message with value: %d, and address: 0x%&quot;</span> <span class="n">PRIXPTR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
        <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
    <span class="p">},</span> <span class="n">rmw_qos_profile_default</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">sub_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="n">BUFSIZ</span><span class="p">);</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">executors</span><span class="o">::</span><span class="n">SingleThreadedExecutor</span> <span class="n">executor</span><span class="p">;</span>

  <span class="k">auto</span> <span class="n">producer</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Producer</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;producer&quot;</span><span class="p">,</span> <span class="s">&quot;number&quot;</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">consumer</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Consumer</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;consumer&quot;</span><span class="p">,</span> <span class="s">&quot;number&quot;</span><span class="p">);</span>

  <span class="n">executor</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">producer</span><span class="p">);</span>
  <span class="n">executor</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">consumer</span><span class="p">);</span>
  <span class="n">executor</span><span class="p">.</span><span class="n">spin</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As you can see by looking at the <code class="docutils literal notranslate"><span class="pre">main</span></code> function, we have a producer and a consumer node, we add them to a single threaded executor, and then call spin.</p>
<p>If you look at the “producer” node’s implementation in the <code class="docutils literal notranslate"><span class="pre">Producer</span></code> struct, you can see that we have created a publisher which publishes on the “number” topic and a timer which periodically creates a new message, prints out its address in memory and its content’s value and then publishes it.</p>
<p>The “consumer” node is a bit simpler, you can see its implementation in the <code class="docutils literal notranslate"><span class="pre">Consumer</span></code> struct, as it only subscribes to the “number” topic and prints the address and value of the message it receives.</p>
<p>The expectation is that the producer will print out an address and value and the consumer will print out a matching address and value.
This demonstrates that intra process communication is indeed working and unnecessary copies are avoided, at least for simple graphs.</p>
<p>Let’s run the demo by executing <code class="docutils literal notranslate"><span class="pre">ros2</span> <span class="pre">run</span> <span class="pre">intra_process_demo</span> <span class="pre">two_node_pipeline</span></code> executable (don’t forget to source the setup file first):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ros2 run intra_process_demo two_node_pipeline
Published message with value: <span class="m">0</span>, and address: 0x7fb02303faf0
Published message with value: <span class="m">1</span>, and address: 0x7fb020cf0520
 Received message with value: <span class="m">1</span>, and address: 0x7fb020cf0520
Published message with value: <span class="m">2</span>, and address: 0x7fb020e12900
 Received message with value: <span class="m">2</span>, and address: 0x7fb020e12900
Published message with value: <span class="m">3</span>, and address: 0x7fb020cf0520
 Received message with value: <span class="m">3</span>, and address: 0x7fb020cf0520
Published message with value: <span class="m">4</span>, and address: 0x7fb020e12900
 Received message with value: <span class="m">4</span>, and address: 0x7fb020e12900
Published message with value: <span class="m">5</span>, and address: 0x7fb02303cea0
 Received message with value: <span class="m">5</span>, and address: 0x7fb02303cea0
<span class="o">[</span>...<span class="o">]</span>
</pre></div>
</div>
<p>One thing you’ll notice is that the messages tick along at about one per second.
This is because we told the timer to fire at about once per second.</p>
<p>Also you may have noticed that the first message (with value <code class="docutils literal notranslate"><span class="pre">0</span></code>) does not have a corresponding “Received message …” line.
This is because publish/subscribe is “best effort” and we do not have any “latching” like behavior enabled.
This means that if the publisher publishes a message before the subscription has been established, the subscription will not receive that message.
This race condition can result in the first few messages being lost.
In this case, since they only come once per second, usually only the first message is lost.</p>
<p>Finally, you can see that “Published message…” and “Received message …” lines with the same value also have the same address.
This shows that the address of the message being received is the same as the one that was published and that it is not a copy.
This is because we’re publishing and subscribing with <code class="docutils literal notranslate"><span class="pre">std::unique_ptr</span></code>s which allow ownership of a message to be moved around the system safely.
You can also publish and subscribe with <code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">&amp;</span></code> and <code class="docutils literal notranslate"><span class="pre">std::shared_ptr</span></code>, but zero-copy will not occur in that case.</p>
</div>
<div class="section" id="the-cyclic-pipeline-demo">
<h3>The cyclic pipeline demo<a class="headerlink" href="#the-cyclic-pipeline-demo" title="Permalink to this headline">¶</a></h3>
<p>This demo is similar to the previous one, but instead of the producer creating a new message for each iteration, this demo only ever uses one message instance.
This is achieved by creating a cycle in the graph and “kicking off” communication by externally making one of the nodes publish before spinning the executor:</p>
<p><a class="reference external" href="https://github.com/ros2/demos/blob/master/intra_process_demo/src/cyclic_pipeline/cyclic_pipeline.cpp">https://github.com/ros2/demos/blob/master/intra_process_demo/src/cyclic_pipeline/cyclic_pipeline.cpp</a></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;chrono&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cinttypes&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;rclcpp/rclcpp.hpp&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;std_msgs/msg/int32.hpp&quot;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono_literals</span><span class="p">;</span>

<span class="c1">// This node receives an Int32, waits 1 second, then increments and sends it.</span>
<span class="k">struct</span> <span class="nl">IncrementerPipe</span> <span class="p">:</span> <span class="k">public</span> <span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span>
<span class="p">{</span>
  <span class="n">IncrementerPipe</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">in</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">out</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">Node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Create a publisher on the output topic.</span>
    <span class="n">pub</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">rmw_qos_profile_default</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">remove_pointer</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="n">pub</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;</span> <span class="n">captured_pub</span> <span class="o">=</span> <span class="n">pub</span><span class="p">;</span>
    <span class="c1">// Create a subscription on the input topic.</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;</span><span class="p">(</span>
      <span class="n">in</span><span class="p">,</span> <span class="p">[</span><span class="n">captured_pub</span><span class="p">](</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">::</span><span class="n">UniquePtr</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">pub_ptr</span> <span class="o">=</span> <span class="n">captured_pub</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pub_ptr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">printf</span><span class="p">(</span>
        <span class="s">&quot;Received message with value:         %d, and address: 0x%&quot;</span> <span class="n">PRIXPTR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
        <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;  sleeping for 1 second...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">1</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>    <span class="c1">// Return if the sleep failed (e.g. on ctrl-c).</span>
      <span class="p">}</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;  done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">++</span><span class="p">;</span>    <span class="c1">// Increment the message&#39;s data.</span>
      <span class="n">printf</span><span class="p">(</span>
        <span class="s">&quot;Incrementing and sending with value: %d, and address: 0x%&quot;</span> <span class="n">PRIXPTR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
        <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
      <span class="n">pub_ptr</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>    <span class="c1">// Send the message along to the output topic.</span>
    <span class="p">},</span> <span class="n">rmw_qos_profile_default</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">rclcpp</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">pub</span><span class="p">;</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">Subscription</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;::</span><span class="n">SharedPtr</span> <span class="n">sub</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IONBF</span><span class="p">,</span> <span class="n">BUFSIZ</span><span class="p">);</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">executors</span><span class="o">::</span><span class="n">SingleThreadedExecutor</span> <span class="n">executor</span><span class="p">;</span>

  <span class="c1">// Create a simple loop by connecting the in and out topics of two IncrementerPipe&#39;s.</span>
  <span class="c1">// The expectation is that the address of the message being passed between them never changes.</span>
  <span class="k">auto</span> <span class="n">pipe1</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">IncrementerPipe</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;pipe1&quot;</span><span class="p">,</span> <span class="s">&quot;topic1&quot;</span><span class="p">,</span> <span class="s">&quot;topic2&quot;</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">pipe2</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">IncrementerPipe</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;pipe2&quot;</span><span class="p">,</span> <span class="s">&quot;topic2&quot;</span><span class="p">,</span> <span class="s">&quot;topic1&quot;</span><span class="p">);</span>
  <span class="n">rclcpp</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="mi">1</span><span class="n">s</span><span class="p">);</span>  <span class="c1">// Wait for subscriptions to be established to avoid race conditions.</span>
  <span class="c1">// Publish the first message (kicking off the cycle).</span>
  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="o">&gt;</span> <span class="n">msg</span><span class="p">(</span><span class="k">new</span> <span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Int32</span><span class="p">());</span>
  <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span>
    <span class="s">&quot;Published first message with value:  %d, and address: 0x%&quot;</span> <span class="n">PRIXPTR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
    <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">get</span><span class="p">()));</span>
  <span class="n">pipe1</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

  <span class="n">executor</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">pipe1</span><span class="p">);</span>
  <span class="n">executor</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">pipe2</span><span class="p">);</span>
  <span class="n">executor</span><span class="p">.</span><span class="n">spin</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Unlike the previous demo, this demo uses only one Node, instantiated twice with different names and configurations.
The graph ends up being <code class="docutils literal notranslate"><span class="pre">pipe1</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">pipe2</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">pipe1</span></code> … in a loop.</p>
<p>The line <code class="docutils literal notranslate"><span class="pre">pipe1-&gt;pub-&gt;publish(msg);</span></code> kicks the process off, but from then on the messages are passed back and forth between the nodes by each one calling publish within its own subscription callback.</p>
<p>The expectation here is that the nodes pass the message back and forth, once a second, incrementing the value of the message each time.
Because the message is being published and subscribed to as a <code class="docutils literal notranslate"><span class="pre">unique_ptr</span></code> the same message created at the beginning is continuously used.</p>
<p>To test those expectations, let’s run it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>% ros2 run intra_process_demo cyclic_pipeline
Published first message with value:  <span class="m">42</span>, and address: 0x7fd2ce0a2bc0
Received message with value:         <span class="m">42</span>, and address: 0x7fd2ce0a2bc0
  sleeping <span class="k">for</span> <span class="m">1</span> second...
  <span class="k">done</span>.
Incrementing and sending with value: <span class="m">43</span>, and address: 0x7fd2ce0a2bc0
Received message with value:         <span class="m">43</span>, and address: 0x7fd2ce0a2bc0
  sleeping <span class="k">for</span> <span class="m">1</span> second...
  <span class="k">done</span>.
Incrementing and sending with value: <span class="m">44</span>, and address: 0x7fd2ce0a2bc0
Received message with value:         <span class="m">44</span>, and address: 0x7fd2ce0a2bc0
  sleeping <span class="k">for</span> <span class="m">1</span> second...
  <span class="k">done</span>.
Incrementing and sending with value: <span class="m">45</span>, and address: 0x7fd2ce0a2bc0
Received message with value:         <span class="m">45</span>, and address: 0x7fd2ce0a2bc0
  sleeping <span class="k">for</span> <span class="m">1</span> second...
  <span class="k">done</span>.
Incrementing and sending with value: <span class="m">46</span>, and address: 0x7fd2ce0a2bc0
Received message with value:         <span class="m">46</span>, and address: 0x7fd2ce0a2bc0
  sleeping <span class="k">for</span> <span class="m">1</span> second...
  <span class="k">done</span>.
Incrementing and sending with value: <span class="m">47</span>, and address: 0x7fd2ce0a2bc0
Received message with value:         <span class="m">47</span>, and address: 0x7fd2ce0a2bc0
  sleeping <span class="k">for</span> <span class="m">1</span> second...
<span class="o">[</span>...<span class="o">]</span>
</pre></div>
</div>
<p>You should see ever increasing numbers on each iteration, starting with 42… because 42, and the whole time it reuses the same message, as demonstrated by the pointer addresses which do not change, which avoids unnecessary copies.</p>
</div>
<div class="section" id="the-image-pipeline-demo">
<h3>The image pipeline demo<a class="headerlink" href="#the-image-pipeline-demo" title="Permalink to this headline">¶</a></h3>
<p>In this demo we’ll use OpenCV to capture, annotate, and then view images.</p>
<p>Note for OS X users: If these examples do not work or you receive an error like <code class="docutils literal notranslate"><span class="pre">ddsi_conn_write</span> <span class="pre">failed</span> <span class="pre">-1</span></code> then you’ll need to increase your system wide UDP packet size:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo sysctl -w net.inet.udp.recvspace<span class="o">=</span><span class="m">209715</span>
$ sudo sysctl -w net.inet.udp.maxdgram<span class="o">=</span><span class="m">65500</span>
</pre></div>
</div>
<p>These changes will not persist after a reboot.</p>
<div class="section" id="simple-pipeline">
<h4>Simple pipeline<a class="headerlink" href="#simple-pipeline" title="Permalink to this headline">¶</a></h4>
<p>First we’ll have a pipeline of three nodes, arranged as such: <code class="docutils literal notranslate"><span class="pre">camera_node</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">watermark_node</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">image_view_node</span></code></p>
<p>The <code class="docutils literal notranslate"><span class="pre">camera_node</span></code> reads from camera device <code class="docutils literal notranslate"><span class="pre">0</span></code> on your computer, writes some information on the image and publishes it.
The <code class="docutils literal notranslate"><span class="pre">watermark_node</span></code> subscribes to the output of the <code class="docutils literal notranslate"><span class="pre">camera_node</span></code> and adds more text before publishing it too.
Finally, the <code class="docutils literal notranslate"><span class="pre">image_view_node</span></code> subscribes to the output of the <code class="docutils literal notranslate"><span class="pre">watermark_node</span></code>, writes more text to the image and then visualizes it with <code class="docutils literal notranslate"><span class="pre">cv::imshow</span></code>.</p>
<p>In each node the address of the message which is being sent, or which has been received, or both, is written to the image.
The watermark and image view nodes are designed to modify the image without copying it and so the addresses imprinted on the image should all be the same as long as the nodes are in the same process and the graph remains organized in a pipeline as sketched above.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On some systems (we’ve seen it happen on Linux), the address printed to the screen might not change.
This is because the same unique pointer is being reused. In this situation, the pipeline is still running.</p>
</div>
<p>Let’s run the demo by executing the following executable:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2 run intra_process_demo image_pipeline_all_in_one
</pre></div>
</div>
<p>You should see something like this:</p>
<a class="reference external image-reference" href="http://i.imgur.com/tqiIVgT.png"><img alt="" src="http://i.imgur.com/tqiIVgT.png" /></a>
<p>You can pause the rendering of the image by pressing the spacebar and you can resume by pressing the spacebar again.
You can also press <code class="docutils literal notranslate"><span class="pre">q</span></code> or <code class="docutils literal notranslate"><span class="pre">ESC</span></code> to exit.</p>
<p>If you pause the image viewer, you should be able to compare the addresses written on the image and see that they are the same.</p>
</div>
<div class="section" id="pipeline-with-two-image-viewers">
<h4>Pipeline with two image viewers<a class="headerlink" href="#pipeline-with-two-image-viewers" title="Permalink to this headline">¶</a></h4>
<p>Now let’s look at an example just like the one above, except it has two image view nodes.
All the nodes are still in the same process, but now two image view windows should show up. (Note for OS X users: your image view windows might be on top of each other).
Let’s run it with the command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2 run intra_process_demo image_pipeline_with_two_image_view
</pre></div>
</div>
<a class="reference external image-reference" href="http://i.imgur.com/iLIT02t.png"><img alt="" src="http://i.imgur.com/iLIT02t.png" /></a>
<p>Just like the last example, you can pause the rendering with the spacebar and continue by pressing the spacebar a second time. You can stop the updating to inspect the pointers written to the screen.</p>
<p>As you can see in the example image above, we have one image with all of the pointers the same and then another image with the same pointers as the first image for the first two entries, but the last pointer on the second image is different. To understand why this is happening consider the graph’s topology:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>camera_node -&gt; watermark_node -&gt; image_view_node
                              -&gt; image_view_node2
</pre></div>
</div>
<p>The link between the <code class="docutils literal notranslate"><span class="pre">camera_node</span></code> and the <code class="docutils literal notranslate"><span class="pre">watermark_node</span></code> can use the same pointer without copying because there is only one intra process subscription to which the message should be delivered. But for the link between the <code class="docutils literal notranslate"><span class="pre">watermark_node</span></code> and the two image view nodes the relationship is one to many, so if the image view nodes were using <code class="docutils literal notranslate"><span class="pre">unique_ptr</span></code> callbacks then it would be impossible to deliver the ownership of the same pointer to both. It can be, however, delivered to one of them. Which one would get the original pointer is not defined, but instead is simply the last to be delivered.</p>
<p>Note that the image view nodes are not subscribed with <code class="docutils literal notranslate"><span class="pre">unique_ptr</span></code> callbacks. Instead they are subscribed with <code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">shared_ptr</span></code>s. This means the system could have delivered the same <code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code> to both callbacks. Currently the intra process system is not that intelligent and so it stores the message internally as a <code class="docutils literal notranslate"><span class="pre">unique_ptr</span></code> and copies it into a <code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code> for each callback until the last one. On the last callback, regardless of the type, the ownership is transferred out of intra process storage and, in the case of the image view, the ownership is moved into a new <code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code> and delivered. Thus, one of the image view nodes gets a copy and the other gets the original.</p>
</div>
<div class="section" id="pipeline-with-interprocess-viewer">
<h4>Pipeline with interprocess viewer<a class="headerlink" href="#pipeline-with-interprocess-viewer" title="Permalink to this headline">¶</a></h4>
<p>One other important thing to get right is to avoid interruption of the intra process zero-copy behavior when interprocess subscriptions are made. To test this we can run the first image pipeline demo, <code class="docutils literal notranslate"><span class="pre">image_pipeline_all_in_one</span></code>, and then run an instance of the stand alone <code class="docutils literal notranslate"><span class="pre">image_view_node</span></code> (don’t forget to prefix them with <code class="docutils literal notranslate"><span class="pre">ros2</span> <span class="pre">run</span> <span class="pre">intra_process_demo</span></code> in the terminal). This will look something like this:</p>
<a class="reference external image-reference" href="http://i.imgur.com/MoWRH1u.png"><img alt="" src="http://i.imgur.com/MoWRH1u.png" /></a>
<p>It’s hard to pause both images at the same time so the images may not line up, but the important thing to notice is that the <code class="docutils literal notranslate"><span class="pre">image_pipeline_all_in_one</span></code> image view shows the same address for each step. This means that the intra process zero-copy is preserved even when an external view is subscribed as well. You can also see that the interprocess image view has different process IDs for the first two lines of text and the process ID of the standalone image viewer in the third line of text.</p>
</div>
</div>
</div>
<div class="section" id="looking-forward">
<h2><a class="toc-backref" href="#id4">Looking forward</a><a class="headerlink" href="#looking-forward" title="Permalink to this headline">¶</a></h2>
<p>These demos are the foundation for some cool new features on which we’re actively working, but right now some things are missing.</p>
<div class="section" id="room-for-improvement">
<h3>Room for Improvement<a class="headerlink" href="#room-for-improvement" title="Permalink to this headline">¶</a></h3>
<p>Let’s start by looking at what we at OSRF know we can do better or differently and move on from there.</p>
<div class="section" id="intra-process-manager-storage">
<h4>Intra Process Manager Storage<a class="headerlink" href="#intra-process-manager-storage" title="Permalink to this headline">¶</a></h4>
<p>At the core of the intra process implementation is something called the intra process manager. It is the shared state between nodes (not necessarily global) which facilitates intra process communication. The intra process manager has a lot of room for improvement, but one thing on our short list is to have it be more intelligent about how to store the user’s data internally. In the example with two image view nodes all in the same process, we could have delivered the user’s provided pointer to both image view nodes as copies of a single <code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code>. This is possible only because of the intra process graph’s structure, but given any relationship of a publisher to one or more intra process subscriptions there should be a preferred solution.</p>
<p>For example, imagine if there was a publisher connected to three intra process subscriptions where one was subscribed as a <code class="docutils literal notranslate"><span class="pre">unique_ptr</span></code> and the other two were subscribed as a <code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code>. If you store the the message as a <code class="docutils literal notranslate"><span class="pre">unique_ptr</span></code> then you must make a copy for each of the <code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code> but you can deliver to the <code class="docutils literal notranslate"><span class="pre">unique_ptr</span></code> callback without a copy. But if you instead stored the message as a <code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code> then you give that <code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code> to the two <code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code> callbacks and make one copy for the <code class="docutils literal notranslate"><span class="pre">unique_ptr</span></code> callback, which would save on copies. In both cases we’ve assumed that only one copy of the message should be stored, i.e. we will not store a <code class="docutils literal notranslate"><span class="pre">unique_ptr</span></code> of the message as well as a <code class="docutils literal notranslate"><span class="pre">shared_ptr</span></code> copy. There is a performance trade-off when decided whether to make those copies or not, so one thing to figure out moving forward is how and when to expose this trade-off to the developer.</p>
<p>This problem gets more interesting when we start doing Type Masquerading :smile:, which we’ll talk about below.</p>
</div>
<div class="section" id="avoiding-unnecessary-interprocess-publishes">
<h4>Avoiding Unnecessary Interprocess Publishes<a class="headerlink" href="#avoiding-unnecessary-interprocess-publishes" title="Permalink to this headline">¶</a></h4>
<p>Currently we’re relying on the middleware, the DDS vendor, to avoid publishing to the wire unnecessarily, but no matter what we have to give the middleware a copy of the user’s message. We could avoid this copy given to the system if we could know if it is needed. We can do this currently by checking to see if there are any non intra process subscriptions currently attached to the publisher. The problem with this becomes apparent when we go to implement latching, which we’ll see more about below.</p>
</div>
<div class="section" id="avoiding-memory-allocation">
<h4>Avoiding Memory Allocation<a class="headerlink" href="#avoiding-memory-allocation" title="Permalink to this headline">¶</a></h4>
<p>In other parts of the system we’ve worked really hard to allow users to avoid memory allocation. This has performance benefits and may be required for real-time or embedded scenarios. We cannot currently do that with intra process. Mostly this is because we haven’t had time to figure out the right interfaces, but the general problem is that if a message needs to be delivered to more than one subscription, or if the user gives us a <code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">&amp;</span></code> or <code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">shared_ptr</span></code> when publishing, we need to make a copy. And the destination of the copy is currently created using <code class="docutils literal notranslate"><span class="pre">new</span></code> and is not configurable. We expect to resolve that in the future.</p>
</div>
<div class="section" id="performance-performance-performance">
<h4>Performance, Performance, Performance<a class="headerlink" href="#performance-performance-performance" title="Permalink to this headline">¶</a></h4>
<p>This is a very rough first draft. There is a lot of room for improvement, even beyond what has been enumerated above. We’ll start to improve performance as we dig into the details of the system, build up a better understanding of exactly what our middleware vendors are doing, and try alternative strategies for implementing intra process.</p>
</div>
</div>
<div class="section" id="what-s-missing">
<h3>What’s Missing<a class="headerlink" href="#what-s-missing" title="Permalink to this headline">¶</a></h3>
<p>Aforementioned are some things we can improve with what’s already there. But there are also some things we’d like to add on top of this that are pretty interesting and some things that are just necessary.</p>
<div class="section" id="latching">
<h4>Latching<a class="headerlink" href="#latching" title="Permalink to this headline">¶</a></h4>
<p>We haven’t fully implemented the concept of latching yet, but it’s very likely we’ll need to adjust the implementation of the intra process manager to account for the fact that late intra process subscriptions should be delivered to as well. There are several options on how to do that, and we’ll do some testing and figure out what to do in the near future.</p>
</div>
<div class="section" id="beyond-pub-sub">
<h4>Beyond Pub/Sub<a class="headerlink" href="#beyond-pub-sub" title="Permalink to this headline">¶</a></h4>
<p>We’ve not done any of this with Services, Parameters, or Actions, but we will.</p>
</div>
<div class="section" id="type-masquerading">
<h4>Type Masquerading<a class="headerlink" href="#type-masquerading" title="Permalink to this headline">¶</a></h4>
<p>This is one of the coolest upcoming features that we didn’t get to in this demo.
Imagine the image pipeline demo above, but rather than passing <code class="docutils literal notranslate"><span class="pre">sensor_msgs/Image</span></code>s around, you’re publishing and subscribing to <code class="docutils literal notranslate"><span class="pre">cv::Mat</span></code> objects. This exists in ROS 1, see: <a class="reference external" href="http://wiki.ros.org/roscpp/Overview/MessagesSerializationAndAdaptingTypes">http://wiki.ros.org/roscpp/Overview/MessagesSerializationAndAdaptingTypes</a></p>
<p>In ROS 1, this is accomplished by serializing/deserializing the third party type when handling it. This means that with intra process you’ll be serializing when passing it between nodelets. But in ROS 2 we want to do it in the most performant way possible. Similar to how these demos have been demonstrating that an instance of a message can be used through the whole pipeline in certain cases, we’d like to do the same with third party types. So conceivably you could have the image pipeline with a single <code class="docutils literal notranslate"><span class="pre">cv::Mat</span></code> which never gets copied by the middleware. To do this requires some additional intelligence in the intra process manager, but we’ve already got a design and some proof of concepts in the works.</p>
<p>Given these features, hopefully there will come a point where you can trust the middleware to handle your data as efficiently as is possible. This will allow you to write performant algorithms without sacrificing modularity or introspection!</p>
</div>
<div class="section" id="tooling">
<h4>Tooling<a class="headerlink" href="#tooling" title="Permalink to this headline">¶</a></h4>
<p>One of the sticking points of Nodelets in ROS 1 was the complexity of defining, building, and using them.
We’ve not tackled that problem yet, but we are working on it. We’ve got a port of class loader (<a class="reference external" href="https://github.com/ros/class_loader/tree/ros2">https://github.com/ros/class_loader/tree/ros2</a>) and pluginlib (<a class="reference external" href="https://github.com/ros/pluginlib/tree/ros2">https://github.com/ros/pluginlib/tree/ros2</a>) for ROS 2, but we only have prototypes of the CMake infrastructure which will help users build and run their nodes. Here’s a sketch of the design we expect:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_node</span><span class="p">(</span><span class="s">my_node</span> <span class="s">src/my_node.cpp</span><span class="p">)</span>
<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">my_node</span> <span class="o">${</span><span class="nv">external_dependency_LIBRARIES</span><span class="o">}</span> <span class="s">...</span><span class="p">)</span>
</pre></div>
</div>
<p>We’ll provide an interface similar to CMake’s <code class="docutils literal notranslate"><span class="pre">add_executable</span></code> or <code class="docutils literal notranslate"><span class="pre">add_library</span></code>. This doesn’t preclude the idea of providing a more automatic solution a la <code class="docutils literal notranslate"><span class="pre">ament_cmake_auto</span></code>.</p>
<p>This simple CMake entry will generate a few things:</p>
<ul class="simple">
<li><p>A marker file used to discover the node by pluginlib.</p></li>
<li><p>A shared library for your node.</p></li>
<li><p>An executable for your node.</p>
<ul>
<li><p>The executable can run the node in its own process, or serve as a proxy while the node runs in a different container.</p></li>
</ul>
</li>
</ul>
<p>We’ll also need to develop the container, which can run nodes inside of itself and is controlled externally by ROS primitives like Services.</p>
<p>We’ve got a lot of work to do, but hopefully this tutorial gives you a sense of where we’re going and what we’re trying to do in terms of performance and features.</p>
</div>
</div>
</div>
</div>

    </div>
  </div>
</div>

      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-4 col-md-4">
          
            <a href="https://github.com/ros-infrastructure" title="Find rosindex in Github">
            <span class="icon  icon--github">
              <svg viewBox="0 0 16 16">
                <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>

            <span class="username">ros-infrastructure</span>
          </a>
          |
          <em>generated on 2019-05-24</em>
        
        </div>
        <div class="col-sm-8 col-md-8 text-right">
          <p class="text">a community-maintained index of robotics software
 | <a href="/privacy.txt">privacy</a></p>
        </div>
      </div>
    </div>
  </div>

</footer>


  </body>

</html>
