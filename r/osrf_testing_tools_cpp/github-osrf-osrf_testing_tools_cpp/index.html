<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>ROS Index</title>
    <meta name="description" content="a community-maintained index of robotics software
">

    
    <link rel="canonical" href="https://ros-infrastructure.github.io/index.ros.org//r/osrf_testing_tools_cpp/github-osrf-osrf_testing_tools_cpp/">
    
    <link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/sphinx.css">
    

    <script type="text/javascript" src=/js/jquery.js></script>
    <script src=/bootstrap/js/bootstrap.min.js type="text/javascript"></script>
    <script src=/js/jquery-cookie-1.4.1/jquery.cookie.js type="text/javascript"></script>

    <script type="text/javascript" src=/js/ga.js async></script>
    <script type="text/javascript" src=/js/toc.js></script>

    <script src=/js/distro_switch.js></script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">
    <div class="container-fluid" style="margin-bottom: 10px">

      <div align="center">
        <br>
        <table id="topnav-table">
          <tr>
            <td valign="middle">
                ROS Resources:
              <a href="http://wiki.ros.org/">Documentation</a>
              |
              <a href="http://wiki.ros.org/Support">Support</a>
              |
              <a href="http://discourse.ros.org/">Discussion Forum</a>
              |
              <a href="http://status.ros.org/">Service Status</a>
              |
              <a href="http://answers.ros.org/">Q&A answers.ros.org</a>
            </td>
          </tr>
        </table> <!-- topnav-table -->
      </div>

      <div class="row">

        <div class="col-sm-12 col-md-9" style="margin-top: 8px">
          <div class="row">
            <!-- title -->
            <div class="col-xs-12 col-sm-3 col-md-3" style="white-space:nowrap;">
              <a class="site-title" href="/">ROS Index</a> <sup><a href="https://github.com/ros-infrastructure/rosindex/issues/new" style="vertical-align:super;" class="label label-warning" target="_blank">BETA</a></sup>
            </div>

            <!-- main links -->
            <div class="col-xs-12 col-sm-9 col-md-9 text-right">
              <ul class="list-inline" style="margin-bottom:0px;">
                <li><a class="btn btn-link" href="/about">About</a></li>

                <li class="dropdown">
                  <button id="dLabel" class="btn btn-link" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Index <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                    <li><a href="/packages/page/1/time/">Package List</a></li>
                    <li><a href="/repos/page/1/time/">Repository List</a></li>

                    <li class="hidden" class="divider"></li>


                    <li class="hidden"><a href="/srvs/">Nodes</a></li>
                    <li class="hidden"><a href="/msgs/">Messages</a></li>
                    <li class="hidden"><a href="/srvs/">Services</a></li>
                    <li class="hidden"><a href="/srvs/">Plugins</a></li>

                    <li class="divider"></li>

                    <li><a href="/deps/">System Dependencies</a></li>
                  </ul>
                </li>

                <li class="dropdown disabled">
                  <button id="dLabel" class="btn btn-link" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Doc <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                    
                    <li>
                      <a href="/doc/ros2">
                        ROS2 Overview
                      </a>
                    </li>
                    
                    <li class="hidden" class="divider"></li>

                    <li class="hidden"><a href="/doc/tutorials">Tutorials</a></li>
                    <li class="hidden"><a href="/doc/readmes">Readmes</a></li>
                    <li class="hidden"><a href="/doc/apis">APIs</a></li>
                  </ul>
                </li>

                <li><a class="btn btn-link" href="/contribute">Contribute</a></li>
                <li><a class="btn btn-link" href="/stats">Stats</a></li>
              </ul>

            </div>
          </div>
        </div>

        <!-- searchbox -->
        <div class="col-sm-12 col-md-3" style="margin-top: 12px">
          <form id="top-searchbox" action="/search/" role="form" method="get">
            <div class="input-group input-group-sm">
              <input type="text" class="form-control" name="term" placeholder="Search ROS">
              <span class="input-group-btn">
                <button class="btn btn-default btn-sm" title="Search ROS" type="submit">
                  <span class="glyphicon glyphicon-search"></span>
                </button>
                <a href="https://lunrjs.com/guides/searching.html"
                   title="Help to Search" class="btn btn-default btn-sm">
                  <span class="glyphicon glyphicon-question-sign"></span>
                </a>
              </span>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!--
    <a class="site-title" href="/">ROS Index</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/packages">Packages</a>
        <a class="page-link" href="/repos">Repositories</a>
        <a class="page-link" href="/search">Search</a>
      </div>
    </nav>
    -->

  </div>
  <script type="text/javascript">
    $('#top-searchbox').submit(function() {
        return $('#top-searchbox input:text').filter(function() {
          return $(this).val() == "";
        }).length == 0;
    });
  </script>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="container-fluid" style="margin-top:20px">
  <div class="container-fluid">
    <div class="row">
      <ol class="breadcrumb">
        <li><a href="/">Home</a></li>
        <li><a href="/repos">Repos</a></li>
        <li class="active">osrf_testing_tools_cpp</li>
        <!--<li class="active">osrf_testing_tools_cpp</li>-->
      </ol>
    </div>
    <div class="row">
      

<div id="distro-switch" class="btn-group btn-group-justified" data-toggle="buttons">
  
    <label id="crystal-option" class="distro-button btn btn-xs btn-primary" href="#crystal" data="crystal">
      <input type="radio" name="options" id="crystal-radio" autocomplete="off"> crystal
    </label>
  
    <label id="bouncy-option" class="distro-button btn btn-xs btn-primary" href="#bouncy" data="bouncy">
      <input type="radio" name="options" id="bouncy-radio" autocomplete="off"> bouncy
    </label>
  
    <label id="melodic-option" class="distro-button btn btn-xs btn-default" href="#melodic" data="melodic">
      <input type="radio" name="options" id="melodic-radio" autocomplete="off"> melodic
    </label>
  
    <label id="lunar-option" class="distro-button btn btn-xs btn-default" href="#lunar" data="lunar">
      <input type="radio" name="options" id="lunar-radio" autocomplete="off"> lunar
    </label>
  
    <label id="kinetic-option" class="distro-button btn btn-xs btn-default" href="#kinetic" data="kinetic">
      <input type="radio" name="options" id="kinetic-radio" autocomplete="off"> kinetic
    </label>
  
    <label id="indigo-option" class="distro-button btn btn-xs btn-default" href="#indigo" data="indigo">
      <input type="radio" name="options" id="indigo-radio" autocomplete="off"> indigo
    </label>
  

  <!-- Older distros -->
  <div class="btn-group dropdown">
    <label type="button" class="btn btn-xs dropdown-toggle btn-default" data-toggle="dropdown" id="older-distro-button">
        <input type="radio" name="options" autocomplete="off">
      <span id="older-label">Older</span>
      <span class="caret"></span>
    </label>
    <ul class="dropdown-menu" role="menu">
      
        <li data="ardent" id="ardent-option" class="disabled older-distro-option"  href="#ardent">
          <a href="#ardent" data="ardent" id="ardent-button">ardent</a>
        </li>
      
        <li data="jade" id="jade-option" class="disabled older-distro-option"  href="#jade">
          <a href="#jade" data="jade" id="jade-button">jade</a>
        </li>
      
        <li data="hydro" id="hydro-option" class="disabled older-distro-option"  href="#hydro">
          <a href="#hydro" data="hydro" id="hydro-button">hydro</a>
        </li>
      
    </ul>
  </div>
</div>

    </div>
    <div class="row">
      &nbsp;
    </div>
    <div class="row">
      <div class="well well-sm">
  <div>
    
  </div>
  
  <table class="table">
    <tr>
      <td width="100px" class="text-center">
        <img style="width: 80px;" src="/assets/repo.png">
      </td>
      <td>
        <h3><a style="text-decoration:none;" href="/r/osrf_testing_tools_cpp">osrf_testing_tools_cpp</a> <small>repository</small></h3>
        
      </td>
    </tr>
  </table>
  <div class="top-buffer">
    
    
<table class="table table-condensed instance-switch">
  <tr>
    <td>
      <div id="repo-switch" class="btn-group btn-group-justified" role="group">
        <div class="btn-group" style="width: 50px">
          <a type="button" class="btn btn-xs btn-default" data-toggle="tooltip" data-placement="left" title="View Instances" 
            href="/repos/osrf_testing_tools_cpp"><span class="glyphicon glyphicon-th"></span></a>
        </div>
        <div class="btn-group" style="width: 90%" role="group">
          <div class="dropdown">
            <!-- TODO: add disabled when only 1 version is known? -->
            <button class="btn btn-xs btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" title="Select Instance">
              <span class="pull-left" style="width: 100%; text-align: left">
                <span class="pull-right"><span class="caret"></span></span> 
              <span class="glyphicon glyphicon-star"></span>
                  github-osrf-osrf_testing_tools_cpp
              </span>
            </button>
            <ul class="dropdown-menu" role="menu">
              
                <li role="presentation">
                  <a id="github-osrf-osrf_testing_tools_cpp" role="menuitem" tabindex="-1" href="/r/osrf_testing_tools_cpp/github-osrf-osrf_testing_tools_cpp" data="github-osrf-osrf_testing_tools_cpp">
                    <span class="glyphicon glyphicon-star"></span>
                    github-osrf-osrf_testing_tools_cpp
                  </a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </td>
  </tr>
</table>

  </div>
  <div class="top-buffer">
  </div>
</div>

    </div>
  </div>
</div>


  <div class="distro distro-crystal">
    <div class="container-fluid">
      
        
        <div class="panel panel-default">
          
          <div class="panel-heading"><h3 class="panel-title">Repository Summary</h3></div>
          <div class="panel-body" style="overflow-x: auto">
            

  <table class="table table-condensed">
    <tr>
      <td style="width:100px;" class="text-right"><b>Checkout URI</b></td>
      <td><a class="label label-default" href="https://github.com/osrf/osrf_testing_tools_cpp.git">https://github.com/osrf/osrf_testing_tools_cpp.git</a></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Type</b></td>
      <td><span class="label label-default">git</span></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Version</b></td>
      <td><span class="label label-default">crystal</span></td>
    </tr>
    <tr>
      <td style="white-space: nowrap;" class="text-right"><b>Last Updated</b></div>
      <td>
        
          <span class="label label-default"><span class="glyphicon glyphicon-time"></span> 2018-11-15
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Dev Status</b></td>
      <td>
        
          
            <span class="label label-success">
          
          DEVELOPED
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Released</b></td>
      <td>
        
          <span class="label label-primary"><span class="glyphicon glyphicon-flash"></span> RELEASED
        </span>
      </td>
    </tr>
  </table>

          </div>
        </div>
        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">Packages</h3></div>
          <div class="panel-body">
            
            
              <table class="table table-condensed table-hover table-striped">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Version</th>
                  </tr>
                </thead>
                <tbody>
                
                  <tr>
                    <td><a href="/p/osrf_testing_tools_cpp/github-osrf-osrf_testing_tools_cpp">osrf_testing_tools_cpp</a></td>
                    <td>1.1.0</td>
                  </tr>
                
                  <tr>
                    <td><a href="/p/test_osrf_testing_tools_cpp/github-osrf-osrf_testing_tools_cpp">test_osrf_testing_tools_cpp</a></td>
                    <td>1.1.0</td>
                  </tr>
                
                </tbody>
              </table>
            
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">README</h3></div>
          <div class="panel-body">
            
              <div class="rendered-markdown">
<h2 id="osrf_testing_tools_cpp-repository">osrf_testing_tools_cpp Repository</h2>

<p>This repository contains testing tools for C++, and is used in OSRF projects.</p>

<h3 id="osrf_testing_tools_cpp">osrf_testing_tools_cpp</h3>

<p>The <code>osrf_testing_tools_cpp</code> folder is where all the actually useful code lives within a cmake project of the same name.</p>

<p>Any CMake based project can use <code>osrf_testing_tools_cpp</code> by using CMake's <code>find_package()</code> and then using the various CMake macros, C++ headers and libraries, and other tools as described below.</p>

<p>This package requires C++11 only, but should also work with C++14 and C++17.</p>

<h4 id="contents">Contents</h4>

<p>There are several useful components in the <code>osrf_testing_tools_cpp</code> project, and they're briefly described below.</p>

<h5 id="googletest">Googletest</h5>

<p>There are a few CMake macros which can provide access to one of a few versions of <code>googletest</code> so that it can be used within your own projects without having to include a copy in each of them.</p>

<h6 id="example">Example</h6>
<div class="highlight"><pre><code class="language-cmake" data-lang="cmake"><span class="nb">include</span><span class="p">(</span>CTest<span class="p">)</span>
<span class="nb">if</span><span class="p">(</span>BUILD_TESTING<span class="p">)</span>
  <span class="nb">find_package</span><span class="p">(</span>osrf_testing_tools_cpp REQUIRED<span class="p">)</span>
  <span class="nf">osrf_testing_tools_cpp_require_googletest</span><span class="p">(</span>VERSION_GTE 1.8<span class="p">)</span>  <span class="c1"># ensures target gtest_main exists</span>

  <span class="nb">add_executable</span><span class="p">(</span>my_gtest ...<span class="p">)</span>
  <span class="nb">target_link_libraries</span><span class="p">(</span>my_gtest gtest_main ...<span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

</code></pre></div>
<p>You can also list the available versions with <code>osrf_testing_tools_cpp_get_googletest_versions()</code>.</p>

<p>This provides access to both "gtest" and "gmock" headers.</p>

<h5 id="add_test-with-environment-variables">add_test with Environment Variables</h5>

<p>There is a CMake macro <code>osrf_testing_tools_cpp_add_test()</code> which acts much like CMake/CTest's <code>add_test()</code> macro, but also has some additional arguments <code>ENV</code>, <code>APPEND_ENV</code> (for <code>PATH</code>-like environment variables), and an OS agnostic <code>APPEND_LIBRARY_DIRS</code>.</p>

<p>This is accomplished with an executable (writtin in C++) which gets put in from of your test executable with additional arguments for any environment variable changes you desire.
This "test runner" executable modifies the environment and then executes your test command as specified.</p>

<h6 id="example">Example</h6>
<div class="highlight"><pre><code class="language-cmake" data-lang="cmake"><span class="nf">osrf_testing_tools_cpp_add_test</span><span class="p">(</span>test_my_executable
  COMMAND <span class="s2">"$&lt;TARGET_FILE:my_executable&gt;"</span> arg1 --arg2
  ENV FOO=bar
  APPEND_ENV PATH=/some/additional/path/bin
  APPEND_LIBRARY_DIRS /some/additional/library/path
<span class="p">)</span>

</code></pre></div>
<p>This might result in CTest output something like this (this example output is from macOS, hence the <code>DYLD_LIBRARY_PATH</code> versus <code>LD_LIBRARY_PATH</code> on Linux or <code>PATH</code> on Windows):</p>
<div class="highlight"><pre><code class="language-" data-lang="">test 1
    Start 1: test_my_executable

1: Test command: /some/path/install/osrf_testing_tools_cpp/lib/osrf_testing_tools_cpp/test_runner "--env" "FOO=bar" "--append-env" "PATH=/some/additional/path/bin" "DYLD_LIBRARY_PATH=/some/additional/library/path" "--" "/some/path/$
build/my_cmake_project/test_example_memory_tools_gtest" "arg1" "--arg2"

</code></pre></div>
<h5 id="memory_tools">memory_tools</h5>

<p>This API lets you intercept calls to dynamic memory calls like <code>malloc</code> and <code>free</code>, and provides some convenience functions for differentiating between expected and unexpected calls to dynamic memory functions.</p>

<p>Right now it only works on Linux and macOS.</p>

<h6 id="example-test">Example Test</h6>

<p>Here's a simple, googletest based example of how it is used:</p>
<div class="highlight"><pre><code class="language-c++" data-lang="c++"><span class="cp">#include &lt;cstdlib&gt;
#include &lt;thread&gt;
</span>
<span class="cp">#include &lt;gtest/gtest.h&gt;
#include &lt;gtest/gtest-spi.h&gt;
</span>
<span class="cp">#include "osrf_testing_tools_cpp/memory_tools/memory_tools.hpp"
#include "osrf_testing_tools_cpp/scope_exit.hpp"
</span>
<span class="kt">void</span> <span class="nf">my_first_function</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span> <span class="n">some_memory</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
  <span class="c1">// .. do something with it</span>
  <span class="n">std</span><span class="o">::</span><span class="n">free</span><span class="p">(</span><span class="n">some_memory</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">my_second_function</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">TestMemoryTools</span><span class="p">,</span> <span class="n">test_example</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// you must initialize memory tools, but uninitialization is optional</span>
  <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">initialize</span><span class="p">();</span>
  <span class="n">OSRF_TESTING_TOOLS_CPP_SCOPE_EXIT</span><span class="p">({</span>
    <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">uninitialize</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="c1">// create a callback for "unexpected" mallocs that does a non-fatal gtest</span>
  <span class="c1">// failure and then register it with memory tools</span>
  <span class="k">auto</span> <span class="n">on_unexpected_malloc</span> <span class="o">=</span>
    <span class="p">[](</span><span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">MemoryToolsService</span> <span class="o">&amp;</span> <span class="n">service</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ADD_FAILURE</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">"unexpected malloc"</span><span class="p">;</span>
      <span class="c1">// this will cause a bracktrace to be printed for each unexpected malloc</span>
      <span class="n">service</span><span class="p">.</span><span class="n">print_backtrace</span><span class="p">();</span>
    <span class="p">};</span>
  <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">on_unexpected_malloc</span><span class="p">(</span><span class="n">on_unexpected_malloc</span><span class="p">);</span>

  <span class="c1">// at this point, you'll still not get callbacks, since monitoring is not enabled</span>
  <span class="c1">// so calling either user function should not fail</span>
  <span class="n">my_first_function</span><span class="p">();</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">my_second_function</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>

  <span class="c1">// enabling monitoring will allow checking to begin, but the default state is</span>
  <span class="c1">// that dynamic memory calls are expected, so again either function will pass</span>
  <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">enable_monitoring</span><span class="p">();</span>
  <span class="n">my_first_function</span><span class="p">();</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">my_second_function</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>

  <span class="c1">// if you then tell memory tools that malloc is unexpected, then it will call</span>
  <span class="c1">// your above callback, at least until you indicate malloc is expected again</span>
  <span class="n">EXPECT_NONFATAL_FAILURE</span><span class="p">({</span>
    <span class="n">EXPECT_NO_MALLOC</span><span class="p">({</span>
      <span class="n">my_first_function</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">},</span> <span class="s">"unexpected malloc"</span><span class="p">);</span>
  <span class="c1">// There are also explicit begin/end functions if you need variables to leave the scope</span>
  <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">expect_no_malloc_begin</span><span class="p">();</span>
  <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">my_second_function</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">expect_no_malloc_end</span><span class="p">();</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

  <span class="c1">// enable monitoring only works in the current thread, but you can enable it for all threads</span>
  <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">enable_monitoring_in_all_threads</span><span class="p">();</span>
  <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span><span class="p">([]()</span> <span class="p">{</span>
    <span class="n">EXPECT_NONFATAL_FAILURE</span><span class="p">({</span>
      <span class="n">EXPECT_NO_MALLOC</span><span class="p">({</span>
        <span class="n">my_first_function</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">},</span> <span class="s">"unexpected malloc"</span><span class="p">);</span>
    <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">expect_no_malloc_begin</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">my_second_function</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">expect_no_malloc_end</span><span class="p">();</span>
    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

  <span class="c1">// disabling monitoring in all threads should not catch the malloc in my_first_function()</span>
  <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">disable_monitoring_in_all_threads</span><span class="p">();</span>
  <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">enable_monitoring</span><span class="p">();</span>
  <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t2</span><span class="p">([]()</span> <span class="p">{</span>
    <span class="n">EXPECT_NO_MALLOC</span><span class="p">({</span>
      <span class="n">my_first_function</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">expect_no_malloc_begin</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">my_second_function</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">expect_no_malloc_end</span><span class="p">();</span>
    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
<span class="p">}</span>

</code></pre></div>
<p>In order for memory tools to work properly and intercept dynamic memory calls in all libraries, the library pre-load environment variable needs to be used, <code>LD_PRELOAD</code> on Linux and <code>DYLD_INSERT_LIBRARIES</code> on macOS.
You can use the above <code>osrf_testing_tools_cpp_add_test()</code> macro to set this environment variable before running any tests, unless you have another way to do so.</p>

<p>For example, here is some CMake code that will build a test and add a CTest for it that properly sets the library pre-load environment variable on all support OS's:</p>
<div class="highlight"><pre><code class="language-cmake" data-lang="cmake"><span class="nb">include</span><span class="p">(</span>CTest<span class="p">)</span>
<span class="nb">if</span><span class="p">(</span>BUILD_TESTING<span class="p">)</span>
  <span class="nb">find_package</span><span class="p">(</span>osrf_testing_tools_cpp REQUIRED<span class="p">)</span>
  <span class="nf">osrf_testing_tools_cpp_require_googletest</span><span class="p">(</span>VERSION_GTE 1.8<span class="p">)</span>  <span class="c1"># ensures target gtest_main exists</span>

  <span class="nb">add_executable</span><span class="p">(</span>test_example_memory_tools_gtest test/test_example_memory_tools.cpp<span class="p">)</span>
  <span class="nb">target_link_libraries</span><span class="p">(</span>test_example_memory_tools_gtest
    gtest_main
    osrf_testing_tools_cpp::memory_tools
  <span class="p">)</span>
  <span class="nb">get_target_property</span><span class="p">(</span>extra_env_vars
    osrf_testing_tools_cpp::memory_tools LIBRARY_PRELOAD_ENVIRONMENT_VARIABLE<span class="p">)</span>
  <span class="nf">osrf_testing_tools_cpp_add_test</span><span class="p">(</span>test_example_memory_tools
    COMMAND <span class="s2">"$&lt;TARGET_FILE:test_example_memory_tools_gtest&gt;"</span>
    ENV <span class="si">${</span><span class="nv">extra_env_vars</span><span class="si">}</span>
  <span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

</code></pre></div>
<p>The <code>LIBRARY_PRELOAD_ENVIRONMENT_VARIABLE</code> property of the <code>osrf_testing_tools_cpp::memory_tools</code> target contains the appropriate environment variable, but is not used automatically.
It must be set before the test is run, and note that the <code>$ENV{}</code> syntax in CMake is not sufficient, as that only affects the environment variables at configure time and not at test time.</p>

<p>You can see this code in action in the <code>test_osrf_testing_tools_cpp</code> example CMake project.</p>

<h5 id="various-c-utilities">Various C++ Utilities</h5>

<h6 id="std-variant-helper">std::variant Helper</h6>

<p>The <code>std::variant</code> feature isn't available until C++17, but using the <a href="https://github.com/mpark/variant">mpark/variant</a> project the <code>osrf_testing_tools_cpp</code> project provides access to a C++11 and C++14 compatible version via the <code>osrf_testing_tools_cpp/variant.hpp</code> header.</p>

<p>In the case that you're using C++17, the normal <code>std::variant</code> is used.
See cppreference.com for documentation:</p>

<p><a href="http://en.cppreference.com/w/cpp/utility/variant">http://en.cppreference.com/w/cpp/utility/variant</a></p>

<h6 id="scope-exit-idiom">Scope Exit Idiom</h6>

<p>The <code>osrf_testing_tools_cpp/scope_exit.hpp</code> header contains a class and a macro to make it easy to perform some code at the exit of the current scope, which is often useful for setting up automatic resource cleanup.</p>

<p>For example:</p>
<div class="highlight"><pre><code class="language-c++" data-lang="c++"><span class="p">{</span>
  <span class="k">auto</span> <span class="n">foo</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">;</span>
  <span class="n">OSRF_TESTING_TOOLS_CPP_SCOPE_EXIT</span><span class="p">({</span>
    <span class="k">delete</span> <span class="n">foo</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">"error that might have caused foo to leak"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></div>
<p>In the above example, <code>foo</code> will be deleted when the scope ends.</p>

<h6 id="demangling-c-symbols">Demangling C++ Symbols</h6>

<p>These functions are in <code>osrf_testing_tools_cpp/demangle.hpp</code> and can be used to generate human readable symbols (on supported) platforms from the result of <code>typeid</code> or a mangled string (gathered from a backtrace or from the output of <code>nm</code>, for example).</p>

<p>You can use it with a type directly:</p>
<div class="highlight"><pre><code class="language-c++" data-lang="c++"><span class="cp">#include &lt;cstdio&gt;
#include &lt;map&gt;
</span>
<span class="cp">#include &lt;osrf_testing_tools_cpp/demangle.hpp&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">float</span><span class="o">&gt;</span> <span class="n">some_map</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">demangle</span><span class="p">(</span><span class="n">some_map</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
  <span class="k">auto</span> <span class="n">type_name</span> <span class="o">=</span> <span class="k">typeid</span><span class="p">(</span><span class="kt">int</span><span class="p">).</span><span class="n">name</span><span class="p">();</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">demangle_str</span><span class="p">(</span><span class="n">type_name</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


</code></pre></div>
<p>This program might output (on supported platforms):</p>
<div class="highlight"><pre><code class="language-" data-lang="">std::__1::map&lt;int, float, std::__1::less&lt;int&gt;, std::__1::allocator&lt;std::__1::pair&lt;int const, float&gt; &gt; &gt;
int

</code></pre></div>
<h3 id="test_osrf_testing_tools_cpp">test_osrf_testing_tools_cpp</h3>

<p>The <code>test_osrf_testing_tools_cpp</code> folder is an example or test cmake project, which demonstrates how to use it, including <code>find_package()</code>'ing it and using <code>memory_tools</code> to implement a test.</p>
</div>
            
          </div>
        </div>

        
        
      
    </div>
  </div>

  <div class="distro distro-bouncy">
    <div class="container-fluid">
      
        
        <div class="panel panel-default">
          
          <div class="panel-heading"><h3 class="panel-title">Repository Summary</h3></div>
          <div class="panel-body" style="overflow-x: auto">
            

  <table class="table table-condensed">
    <tr>
      <td style="width:100px;" class="text-right"><b>Checkout URI</b></td>
      <td><a class="label label-default" href="https://github.com/osrf/osrf_testing_tools_cpp.git">https://github.com/osrf/osrf_testing_tools_cpp.git</a></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Type</b></td>
      <td><span class="label label-default">git</span></td>
    </tr>
    <tr>
      <td class="text-right"><b>VCS Version</b></td>
      <td><span class="label label-default">master</span></td>
    </tr>
    <tr>
      <td style="white-space: nowrap;" class="text-right"><b>Last Updated</b></div>
      <td>
        
          <span class="label label-default"><span class="glyphicon glyphicon-time"></span> 2019-05-20
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Dev Status</b></td>
      <td>
        
          
            <span class="label label-success">
          
          DEVELOPED
        </span>
      </td>
    </tr>
    <tr>
      <td class="text-right"><b>Released</b></td>
      <td>
        
          <span class="label label-primary"><span class="glyphicon glyphicon-flash"></span> RELEASED
        </span>
      </td>
    </tr>
  </table>

          </div>
        </div>
        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">Packages</h3></div>
          <div class="panel-body">
            
            
              <table class="table table-condensed table-hover table-striped">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Version</th>
                  </tr>
                </thead>
                <tbody>
                
                  <tr>
                    <td><a href="/p/osrf_testing_tools_cpp/github-osrf-osrf_testing_tools_cpp">osrf_testing_tools_cpp</a></td>
                    <td>1.2.1</td>
                  </tr>
                
                  <tr>
                    <td><a href="/p/test_osrf_testing_tools_cpp/github-osrf-osrf_testing_tools_cpp">test_osrf_testing_tools_cpp</a></td>
                    <td>1.2.1</td>
                  </tr>
                
                </tbody>
              </table>
            
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading"><h3 class="panel-title">README</h3></div>
          <div class="panel-body">
            
              <div class="rendered-markdown">
<h2 id="osrf_testing_tools_cpp-repository">osrf_testing_tools_cpp Repository</h2>

<p>This repository contains testing tools for C++, and is used in OSRF projects.</p>

<h3 id="osrf_testing_tools_cpp">osrf_testing_tools_cpp</h3>

<p>The <code>osrf_testing_tools_cpp</code> folder is where all the actually useful code lives within a cmake project of the same name.</p>

<p>Any CMake based project can use <code>osrf_testing_tools_cpp</code> by using CMake's <code>find_package()</code> and then using the various CMake macros, C++ headers and libraries, and other tools as described below.</p>

<p>This package requires C++11 only, but should also work with C++14 and C++17.</p>

<h4 id="contents">Contents</h4>

<p>There are several useful components in the <code>osrf_testing_tools_cpp</code> project, and they're briefly described below.</p>

<h5 id="googletest">Googletest</h5>

<p>There are a few CMake macros which can provide access to one of a few versions of <code>googletest</code> so that it can be used within your own projects without having to include a copy in each of them.</p>

<h6 id="example">Example</h6>
<div class="highlight"><pre><code class="language-cmake" data-lang="cmake"><span class="nb">include</span><span class="p">(</span>CTest<span class="p">)</span>
<span class="nb">if</span><span class="p">(</span>BUILD_TESTING<span class="p">)</span>
  <span class="nb">find_package</span><span class="p">(</span>osrf_testing_tools_cpp REQUIRED<span class="p">)</span>
  <span class="nf">osrf_testing_tools_cpp_require_googletest</span><span class="p">(</span>VERSION_GTE 1.8<span class="p">)</span>  <span class="c1"># ensures target gtest_main exists</span>

  <span class="nb">add_executable</span><span class="p">(</span>my_gtest ...<span class="p">)</span>
  <span class="nb">target_link_libraries</span><span class="p">(</span>my_gtest gtest_main ...<span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

</code></pre></div>
<p>You can also list the available versions with <code>osrf_testing_tools_cpp_get_googletest_versions()</code>.</p>

<p>This provides access to both "gtest" and "gmock" headers.</p>

<h5 id="add_test-with-environment-variables">add_test with Environment Variables</h5>

<p>There is a CMake macro <code>osrf_testing_tools_cpp_add_test()</code> which acts much like CMake/CTest's <code>add_test()</code> macro, but also has some additional arguments <code>ENV</code>, <code>APPEND_ENV</code> (for <code>PATH</code>-like environment variables), and an OS agnostic <code>APPEND_LIBRARY_DIRS</code>.</p>

<p>This is accomplished with an executable (writtin in C++) which gets put in from of your test executable with additional arguments for any environment variable changes you desire.
This "test runner" executable modifies the environment and then executes your test command as specified.</p>

<h6 id="example">Example</h6>
<div class="highlight"><pre><code class="language-cmake" data-lang="cmake"><span class="nf">osrf_testing_tools_cpp_add_test</span><span class="p">(</span>test_my_executable
  COMMAND <span class="s2">"$&lt;TARGET_FILE:my_executable&gt;"</span> arg1 --arg2
  ENV FOO=bar
  APPEND_ENV PATH=/some/additional/path/bin
  APPEND_LIBRARY_DIRS /some/additional/library/path
<span class="p">)</span>

</code></pre></div>
<p>This might result in CTest output something like this (this example output is from macOS, hence the <code>DYLD_LIBRARY_PATH</code> versus <code>LD_LIBRARY_PATH</code> on Linux or <code>PATH</code> on Windows):</p>
<div class="highlight"><pre><code class="language-" data-lang="">test 1
    Start 1: test_my_executable

1: Test command: /some/path/install/osrf_testing_tools_cpp/lib/osrf_testing_tools_cpp/test_runner "--env" "FOO=bar" "--append-env" "PATH=/some/additional/path/bin" "DYLD_LIBRARY_PATH=/some/additional/library/path" "--" "/some/path/$
build/my_cmake_project/test_example_memory_tools_gtest" "arg1" "--arg2"

</code></pre></div>
<h5 id="memory_tools">memory_tools</h5>

<p>This API lets you intercept calls to dynamic memory calls like <code>malloc</code> and <code>free</code>, and provides some convenience functions for differentiating between expected and unexpected calls to dynamic memory functions.</p>

<p>Right now it only works on Linux and macOS.</p>

<h6 id="example-test">Example Test</h6>

<p>Here's a simple, googletest based example of how it is used:</p>
<div class="highlight"><pre><code class="language-c++" data-lang="c++"><span class="cp">#include &lt;cstdlib&gt;
#include &lt;thread&gt;
</span>
<span class="cp">#include &lt;gtest/gtest.h&gt;
#include &lt;gtest/gtest-spi.h&gt;
</span>
<span class="cp">#include "osrf_testing_tools_cpp/memory_tools/memory_tools.hpp"
#include "osrf_testing_tools_cpp/scope_exit.hpp"
</span>
<span class="kt">void</span> <span class="nf">my_first_function</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span> <span class="n">some_memory</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
  <span class="c1">// .. do something with it</span>
  <span class="n">std</span><span class="o">::</span><span class="n">free</span><span class="p">(</span><span class="n">some_memory</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">my_second_function</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">TEST</span><span class="p">(</span><span class="n">TestMemoryTools</span><span class="p">,</span> <span class="n">test_example</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// you must initialize memory tools, but uninitialization is optional</span>
  <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">initialize</span><span class="p">();</span>
  <span class="n">OSRF_TESTING_TOOLS_CPP_SCOPE_EXIT</span><span class="p">({</span>
    <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">uninitialize</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="c1">// create a callback for "unexpected" mallocs that does a non-fatal gtest</span>
  <span class="c1">// failure and then register it with memory tools</span>
  <span class="k">auto</span> <span class="n">on_unexpected_malloc</span> <span class="o">=</span>
    <span class="p">[](</span><span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">MemoryToolsService</span> <span class="o">&amp;</span> <span class="n">service</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ADD_FAILURE</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">"unexpected malloc"</span><span class="p">;</span>
      <span class="c1">// this will cause a bracktrace to be printed for each unexpected malloc</span>
      <span class="n">service</span><span class="p">.</span><span class="n">print_backtrace</span><span class="p">();</span>
    <span class="p">};</span>
  <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">on_unexpected_malloc</span><span class="p">(</span><span class="n">on_unexpected_malloc</span><span class="p">);</span>

  <span class="c1">// at this point, you'll still not get callbacks, since monitoring is not enabled</span>
  <span class="c1">// so calling either user function should not fail</span>
  <span class="n">my_first_function</span><span class="p">();</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">my_second_function</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>

  <span class="c1">// enabling monitoring will allow checking to begin, but the default state is</span>
  <span class="c1">// that dynamic memory calls are expected, so again either function will pass</span>
  <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">enable_monitoring</span><span class="p">();</span>
  <span class="n">my_first_function</span><span class="p">();</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">my_second_function</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>

  <span class="c1">// if you then tell memory tools that malloc is unexpected, then it will call</span>
  <span class="c1">// your above callback, at least until you indicate malloc is expected again</span>
  <span class="n">EXPECT_NONFATAL_FAILURE</span><span class="p">({</span>
    <span class="n">EXPECT_NO_MALLOC</span><span class="p">({</span>
      <span class="n">my_first_function</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">},</span> <span class="s">"unexpected malloc"</span><span class="p">);</span>
  <span class="c1">// There are also explicit begin/end functions if you need variables to leave the scope</span>
  <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">expect_no_malloc_begin</span><span class="p">();</span>
  <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">my_second_function</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">expect_no_malloc_end</span><span class="p">();</span>
  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

  <span class="c1">// enable monitoring only works in the current thread, but you can enable it for all threads</span>
  <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">enable_monitoring_in_all_threads</span><span class="p">();</span>
  <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span><span class="p">([]()</span> <span class="p">{</span>
    <span class="n">EXPECT_NONFATAL_FAILURE</span><span class="p">({</span>
      <span class="n">EXPECT_NO_MALLOC</span><span class="p">({</span>
        <span class="n">my_first_function</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">},</span> <span class="s">"unexpected malloc"</span><span class="p">);</span>
    <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">expect_no_malloc_begin</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">my_second_function</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">expect_no_malloc_end</span><span class="p">();</span>
    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

  <span class="c1">// disabling monitoring in all threads should not catch the malloc in my_first_function()</span>
  <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">disable_monitoring_in_all_threads</span><span class="p">();</span>
  <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">enable_monitoring</span><span class="p">();</span>
  <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t2</span><span class="p">([]()</span> <span class="p">{</span>
    <span class="n">EXPECT_NO_MALLOC</span><span class="p">({</span>
      <span class="n">my_first_function</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">expect_no_malloc_begin</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">my_second_function</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">memory_tools</span><span class="o">::</span><span class="n">expect_no_malloc_end</span><span class="p">();</span>
    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="p">});</span>
  <span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
<span class="p">}</span>

</code></pre></div>
<p>In order for memory tools to work properly and intercept dynamic memory calls in all libraries, the library pre-load environment variable needs to be used, <code>LD_PRELOAD</code> on Linux and <code>DYLD_INSERT_LIBRARIES</code> on macOS.
You can use the above <code>osrf_testing_tools_cpp_add_test()</code> macro to set this environment variable before running any tests, unless you have another way to do so.</p>

<p>For example, here is some CMake code that will build a test and add a CTest for it that properly sets the library pre-load environment variable on all support OS's:</p>
<div class="highlight"><pre><code class="language-cmake" data-lang="cmake"><span class="nb">include</span><span class="p">(</span>CTest<span class="p">)</span>
<span class="nb">if</span><span class="p">(</span>BUILD_TESTING<span class="p">)</span>
  <span class="nb">find_package</span><span class="p">(</span>osrf_testing_tools_cpp REQUIRED<span class="p">)</span>
  <span class="nf">osrf_testing_tools_cpp_require_googletest</span><span class="p">(</span>VERSION_GTE 1.8<span class="p">)</span>  <span class="c1"># ensures target gtest_main exists</span>

  <span class="nb">add_executable</span><span class="p">(</span>test_example_memory_tools_gtest test/test_example_memory_tools.cpp<span class="p">)</span>
  <span class="nb">target_link_libraries</span><span class="p">(</span>test_example_memory_tools_gtest
    gtest_main
    osrf_testing_tools_cpp::memory_tools
  <span class="p">)</span>
  <span class="nb">get_target_property</span><span class="p">(</span>extra_env_vars
    osrf_testing_tools_cpp::memory_tools LIBRARY_PRELOAD_ENVIRONMENT_VARIABLE<span class="p">)</span>
  <span class="nf">osrf_testing_tools_cpp_add_test</span><span class="p">(</span>test_example_memory_tools
    COMMAND <span class="s2">"$&lt;TARGET_FILE:test_example_memory_tools_gtest&gt;"</span>
    ENV <span class="si">${</span><span class="nv">extra_env_vars</span><span class="si">}</span>
  <span class="p">)</span>
<span class="nb">endif</span><span class="p">()</span>

</code></pre></div>
<p>The <code>LIBRARY_PRELOAD_ENVIRONMENT_VARIABLE</code> property of the <code>osrf_testing_tools_cpp::memory_tools</code> target contains the appropriate environment variable, but is not used automatically.
It must be set before the test is run, and note that the <code>$ENV{}</code> syntax in CMake is not sufficient, as that only affects the environment variables at configure time and not at test time.</p>

<p>You can see this code in action in the <code>test_osrf_testing_tools_cpp</code> example CMake project.</p>

<h5 id="various-c-utilities">Various C++ Utilities</h5>

<h6 id="std-variant-helper">std::variant Helper</h6>

<p>The <code>std::variant</code> feature isn't available until C++17, but using the <a href="https://github.com/mpark/variant">mpark/variant</a> project the <code>osrf_testing_tools_cpp</code> project provides access to a C++11 and C++14 compatible version via the <code>osrf_testing_tools_cpp/variant.hpp</code> header.</p>

<p>In the case that you're using C++17, the normal <code>std::variant</code> is used.
See cppreference.com for documentation:</p>

<p><a href="http://en.cppreference.com/w/cpp/utility/variant">http://en.cppreference.com/w/cpp/utility/variant</a></p>

<h6 id="scope-exit-idiom">Scope Exit Idiom</h6>

<p>The <code>osrf_testing_tools_cpp/scope_exit.hpp</code> header contains a class and a macro to make it easy to perform some code at the exit of the current scope, which is often useful for setting up automatic resource cleanup.</p>

<p>For example:</p>
<div class="highlight"><pre><code class="language-c++" data-lang="c++"><span class="p">{</span>
  <span class="k">auto</span> <span class="n">foo</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">;</span>
  <span class="n">OSRF_TESTING_TOOLS_CPP_SCOPE_EXIT</span><span class="p">({</span>
    <span class="k">delete</span> <span class="n">foo</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">"error that might have caused foo to leak"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></div>
<p>In the above example, <code>foo</code> will be deleted when the scope ends.</p>

<h6 id="demangling-c-symbols">Demangling C++ Symbols</h6>

<p>These functions are in <code>osrf_testing_tools_cpp/demangle.hpp</code> and can be used to generate human readable symbols (on supported) platforms from the result of <code>typeid</code> or a mangled string (gathered from a backtrace or from the output of <code>nm</code>, for example).</p>

<p>You can use it with a type directly:</p>
<div class="highlight"><pre><code class="language-c++" data-lang="c++"><span class="cp">#include &lt;cstdio&gt;
#include &lt;map&gt;
</span>
<span class="cp">#include &lt;osrf_testing_tools_cpp/demangle.hpp&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">float</span><span class="o">&gt;</span> <span class="n">some_map</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">demangle</span><span class="p">(</span><span class="n">some_map</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
  <span class="k">auto</span> <span class="n">type_name</span> <span class="o">=</span> <span class="k">typeid</span><span class="p">(</span><span class="kt">int</span><span class="p">).</span><span class="n">name</span><span class="p">();</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">osrf_testing_tools_cpp</span><span class="o">::</span><span class="n">demangle_str</span><span class="p">(</span><span class="n">type_name</span><span class="p">).</span><span class="n">c_str</span><span class="p">());</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


</code></pre></div>
<p>This program might output (on supported platforms):</p>
<div class="highlight"><pre><code class="language-" data-lang="">std::__1::map&lt;int, float, std::__1::less&lt;int&gt;, std::__1::allocator&lt;std::__1::pair&lt;int const, float&gt; &gt; &gt;
int

</code></pre></div>
<h3 id="test_osrf_testing_tools_cpp">test_osrf_testing_tools_cpp</h3>

<p>The <code>test_osrf_testing_tools_cpp</code> folder is an example or test cmake project, which demonstrates how to use it, including <code>find_package()</code>'ing it and using <code>memory_tools</code> to implement a test.</p>
</div>
            
          </div>
        </div>

        
        
      
    </div>
  </div>

  <div class="distro distro-melodic">
    <div class="container-fluid">
      
        <div class="alert alert-warning" role="alert">No version for distro <strong>melodic</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-lunar">
    <div class="container-fluid">
      
        <div class="alert alert-warning" role="alert">No version for distro <strong>lunar</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-kinetic">
    <div class="container-fluid">
      
        <div class="alert alert-warning" role="alert">No version for distro <strong>kinetic</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-indigo">
    <div class="container-fluid">
      
        <div class="alert alert-warning" role="alert">No version for distro <strong>indigo</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-ardent">
    <div class="container-fluid">
      
        <div class="alert alert-warning" role="alert">No version for distro <strong>ardent</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-jade">
    <div class="container-fluid">
      
        <div class="alert alert-warning" role="alert">No version for distro <strong>jade</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>

  <div class="distro distro-hydro">
    <div class="container-fluid">
      
        <div class="alert alert-warning" role="alert">No version for distro <strong>hydro</strong>. Known supported distros are highlighted in the buttons above.</div>
      
    </div>
  </div>


<script type="text/javascript">
  $(document).ready(function() {
    setupDistroSwitch("crystal");
  });
</script>

      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-4 col-md-4">
          
            <a href="https://github.com/ros-infrastructure" title="Find rosindex in Github">
            <span class="icon  icon--github">
              <svg viewBox="0 0 16 16">
                <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>

            <span class="username">ros-infrastructure</span>
          </a>
          |
          <em>generated on 2019-05-24</em>
        
        </div>
        <div class="col-sm-8 col-md-8 text-right">
          <p class="text">a community-maintained index of robotics software
 | <a href="/privacy.txt">privacy</a></p>
        </div>
      </div>
    </div>
  </div>

</footer>


  </body>

</html>
